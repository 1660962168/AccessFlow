{% extends "base.html" %}

{% block title %}实时监控 - 智泊管理{% endblock %}

{% block content %}
<style>
    /* 动态网格布局 */
    .monitor-grid {
        display: grid;
        /* 自适应列：最小宽度 450px，放不下自动换行 */
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); 
        gap: 20px;
        margin-bottom: 30px;
    }

    .monitor-card {
        background: var(--white);
        border-radius: 8px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.05);
        display: flex;
        flex-direction: column;
        border-top: 4px solid var(--primary-color);
        min-height: 400px; /* 保证卡片有高度 */
    }

    /* 出口类型改为绿色顶部 */
    .monitor-card[data-type="exit"] {
        border-top-color: var(--success-color);
    }

    .monitor-header {
        padding: 12px 20px;
        border-bottom: 1px solid #e3e6f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* 视频播放/占位区 */
    .video-wrapper {
        flex-grow: 1;
        background-color: #1a1c23;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    /* 视频流样式 */
    .video-stream {
        width: 100%;
        height: 400px;
        object-fit: contain; /* 保持比例 */
        display: block;
    }

    /* 底部 OCR 结果样式 */
    .monitor-footer {
        padding: 10px 20px;
        background: #f8f9fc;
        border-top: 1px solid #eee;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .ocr-result-box {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
        background: #fff;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .plate-number {
        font-weight: bold;
        font-size: 1.1rem;
        color: var(--primary-color);
    }
</style>
<div class="page-content">
<div class="page-title">
    <i class="fas fa-video"></i> 实时监控中心 
    <span style="font-size: 0.9rem; color: #888; margin-left: 10px;">(共配置 {{ cameras|length }} 路视频流)</span>
</div>

{% if cameras|length == 0 %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i> 当前未配置任何监控视频流。请前往 <a href="{{ url_for('system_config') }}"><b>系统配置</b></a> 页面添加 RTSP 视频源。
</div>
{% endif %}

<div class="monitor-grid">
    
    {% for cam in cameras %}
    <div class="monitor-card" data-type="{{ cam.cam_type }}" data-id="{{ cam.id }}">
        <div class="monitor-header">
            <div style="font-weight: bold; color: #5a5c69;">
                {% if cam.cam_type == 'entrance' %}
                    <i class="fas fa-sign-in-alt" style="color: var(--primary-color);"></i>
                {% else %}
                    <i class="fas fa-sign-out-alt" style="color: var(--success-color);"></i>
                {% endif %}
                {{ cam.name }}
            </div>
            <span style="font-size: 0.75rem; color: #1cc88a;"><i class="fas fa-circle" style="font-size: 0.5rem;"></i> LIVE</span>
        </div>

        <div class="video-wrapper">
            <img class="video-stream" src="{{ url_for('video_feed', cam_id=cam.id) }}" alt="正在加载视频流...">
        </div>

        <div class="monitor-footer">
            <div class="ocr-result-box">
                <span><i class="fas fa-car"></i> 识别车牌:</span>
                <span class="plate-number" id="plate-{{ cam.id }}">等待识别...</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #666;">
                <span id="time-{{ cam.id }}">--:--:--</span>
                <span>ID: {{ cam.id }}</span>
            </div>
        </div>
    </div>
    {% endfor %}

</div>
</div>
<script>
    function updateMonitorData() {
        fetch('/monitor/data')
            .then(response => response.json())
            .then(data => {
                // data 结构: { "1": {"plate": "京A...", "time": "..."}, "2": ... }
                for (const [camId, info] of Object.entries(data)) {
                    const plateEl = document.getElementById(`plate-${camId}`);
                    const timeEl = document.getElementById(`time-${camId}`);
                    
                    if (plateEl && info.plate) {
                        plateEl.textContent = info.plate;
                        // 如果置信度低可以用不同颜色，这里暂时默认
                    }
                    if (timeEl && info.time) {
                        timeEl.textContent = "识别时间: " + info.time;
                    }
                }
            })
            .catch(err => console.error('获取监控数据失败:', err));
    }

    // 每 1 秒刷新一次 OCR 数据
    setInterval(updateMonitorData, 1000);
</script>

{% endblock %}