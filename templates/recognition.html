{% extends "base.html" %}

{% block title %}识别测试 - 智泊管理{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/recognition.css') }}">
<div class="page-content">
<div class="page-title">
    <i class="fa-solid fa-photo-film"></i> 智能识别测试
</div>

<div class="recognition-wrapper">
    
    <div class="card control-panel">
        <div class="card-body">
            <h4 style="color: var(--primary-color); margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <i class="fas fa-cogs"></i> 配置面板
            </h4>

            <form id="recognitionForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label class="form-label">上传测试图片</label>
                    <div class="upload-area" id="dropArea" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <p style="margin: 0; color: #5a5c69; font-weight: 600;">点击或拖拽文件至此</p>
                        <p style="font-size: 0.8rem; color: #858796;">支持 JPG, PNG, JPEG</p>
                        <input type="file" id="fileInput" name="file" accept="image/*" style="display: none;" onchange="previewImage(this)">
                    </div>
                    <div id="fileName" style="margin-top: 10px; font-size: 0.85rem; color: var(--primary-color); text-align: center;"></div>
                </div>

                <hr style="border-top: 1px solid #eee; margin: 20px 0;">

                <div class="form-group">
                    <label class="form-label">YOLO 置信度阈值 (Confidence)</label>
                    <div class="range-container">
                        <input type="range" name="conf_thres" min="0" max="1" step="0.05" value="0.5" 
                               oninput="document.getElementById('confVal').innerText = this.value">
                        <span id="confVal" class="range-value">0.5</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">NMS IOU 阈值</label>
                    <div class="range-container">
                        <input type="range" name="iou_thres" min="0" max="1" step="0.05" value="0.45" 
                               oninput="document.getElementById('iouVal').innerText = this.value">
                        <span id="iouVal" class="range-value">0.45</span>
                    </div>
                </div>

                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <label class="form-label" style="margin: 0;">启用 OCR 车牌识别</label>
                    <label class="toggle-switch">
                        <input type="checkbox" name="use_ocr" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="form-actions" style="margin-top: 30px;">
                    <button type="button" class="btn-submit" style="width: 100%; display: flex; justify-content: center; align-items: center;" onclick="submitRecognition()">
                        <i class="fas fa-play" style="margin-right: 8px;"></i> 开始识别分析
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card display-panel">
        <div class="card-body">
            <h4 style="color: var(--info-color); margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between;">
                <span><i class="fas fa-chart-area"></i> 识别结果</span>
                <span id="processTime" style="font-size: 0.9rem; color: #858796;">耗时: - ms</span>
            </h4>

            <div class="preview-container">
                <div>
                    <h5 class="form-label">原始图像</h5>
                    <div class="image-box">
                        <span class="box-label">Original</span>
                        <img id="previewImg" src="" style="display: none;">
                        <div class="empty-placeholder" id="previewPlaceholder">
                            <i class="fas fa-image" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            暂无图片
                        </div>
                    </div>
                </div>

                <div>
                    <h5 class="form-label">识别结果</h5>
                    <div class="image-box">
                        <span class="box-label" style="background: var(--primary-color);">Result</span>
                        <img id="resultImg" src="" style="display: none;">
                        <div class="empty-placeholder" id="resultPlaceholder">
                            <i class="fas fa-magic" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            等待处理
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 25px;">
                <h5 class="form-label"><i class="fas fa-terminal"></i> 识别详情数据</h5>
                <div class="result-logs" id="logOutput">> 系统就绪，等待上传图片...</div>
            </div>

            <div id="ocrResultTable" style="margin-top: 20px; display: none;">
                <h5 class="form-label">车辆信息提取</h5>
                <div class="table-container">
                    <table class="responsive-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>车牌号码</th>
                                <th>置信度</th>
                                <th>车辆类型</th>
                            </tr>
                        </thead>
                        <tbody id="ocrTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>
</div>
<script>
    // 1. 拖拽上传逻辑
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropArea.classList.add('dragover');
    }

    function unhighlight(e) {
        dropArea.classList.remove('dragover');
    }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        previewImage(fileInput);
    }

    // 2. 图片预览逻辑
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('previewImg').style.display = 'block';
                document.getElementById('previewPlaceholder').style.display = 'none';
                document.getElementById('fileName').innerText = "已选择: " + input.files[0].name;
                
                // 重置状态
                document.getElementById('resultImg').style.display = 'none';
                document.getElementById('resultPlaceholder').style.display = 'flex';
                document.getElementById('logOutput').innerHTML = "> 图片已加载，准备识别...";
                document.getElementById('ocrResultTable').style.display = 'none';
                document.getElementById('ocrTableBody').innerHTML = '';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 3. 提交识别逻辑
    function submitRecognition() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) {
            alert('请先上传一张图片！');
            return;
        }

        const formData = new FormData(document.getElementById('recognitionForm'));
        const logOutput = document.getElementById('logOutput');
        
        // 设置 Loading 状态
        logOutput.innerHTML = "> 正在上传图片...\n> 正在进行 YOLO 目标检测...\n> (如果启用) 正在进行后台 OCR 识别...";
        const btn = document.querySelector('.btn-submit');
        const originalBtnText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
        btn.disabled = true;

        // 发起 POST 请求
        fetch('/recognition', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 1. 显示结果图片
                const resultImg = document.getElementById('resultImg');
                resultImg.src = data.image_url; 
                resultImg.style.display = 'block';
                document.getElementById('resultPlaceholder').style.display = 'none';

                // 2. 更新日志文本
                let logs = `> 识别成功！\n> 总耗时: ${data.time_elapsed}s\n`;
                
                if(data.results && data.results.length > 0) {
                    logs += `> 检测到 ${data.results.length} 个目标:\n`;
                    data.results.forEach((item, index) => {
                        // 格式化坐标显示
                        const bbox = item.bbox.map(n => Math.round(n)); 
                        logs += `  [${index+1}] 类型: ${item.label}, 置信度: ${item.conf}, 坐标: [${bbox}]\n`;
                    });
                } else {
                    logs += "> 未检测到明显目标。\n";
                }
                
                if (data.ocr_data && data.ocr_data.length > 0) {
                    logs += `> OCR 成功识别 ${data.ocr_data.length} 条文本信息。\n`;
                } else if (formData.get('use_ocr') === 'on') {
                    logs += `> OCR 未识别到有效文本 (或模型仍在后台初始化)。\n`;
                }

                logOutput.innerHTML = logs;
                document.getElementById('processTime').innerText = `耗时: ${data.time_elapsed}s`;

                // 3. 填充表格数据 (如果有 OCR 结果)
                if (data.ocr_data && data.ocr_data.length > 0) {
                    document.getElementById('ocrResultTable').style.display = 'block';
                    const tbody = document.getElementById('ocrTableBody');
                    tbody.innerHTML = ''; // 清空旧数据
                    
                    data.ocr_data.forEach((row, i) => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${i + 1}</td>
                                <td><span class="status-badge status-in" style="background:#e6f4ea; color:#1cc88a; padding:4px 8px; border-radius:4px;">${row.text}</span></td>
                                <td>${row.conf}</td>
                                <td>${row.type || '未知'}</td>
                            </tr>
                        `;
                    });
                }
            } else {
                // 处理后端返回的失败信息
                logOutput.innerHTML += `\n> 错误: ${data.message}`;
                alert('识别失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            logOutput.innerHTML += `\n> 网络请求错误或服务器无响应`;
            alert('请求失败，请检查控制台网络日志');
        })
        .finally(() => {
            // 恢复按钮状态
            btn.innerHTML = originalBtnText;
            btn.disabled = false;
        });
    }
</script>
{% endblock %}